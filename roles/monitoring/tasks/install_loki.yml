---
- name: Install Loki using Helm
  when: loki_enabled
  block:
    - name: Ensure monitoring namespace exists for Loki
      kubernetes.core.k8s:
        state: present
        api_version: v1
        kind: Namespace
        name: "{{ monitoring_namespace }}"
    - name: Install grafana/loki chart
      kubernetes.core.helm:
        name: "{{ loki_release_name }}"
        chart_ref: "{{ loki_chart_ref }}"
        chart_version: "{{ loki_chart_version }}"
        release_namespace: "{{ monitoring_namespace }}"
        create_namespace: false
        values:
          deploymentMode: "SingleBinary"
          # ensure Loki uses local filesystem storage for SingleBinary (no object store)
          loki:
            storage:
              type: "filesystem"
              # explicitly disable thanos/object-store usage for safety
              use_thanos_objstore: false
            # Enable volume handling for TSDB (required for local filesystem storage)
            volume_enabled: true
            # Use a TSDB schema suitable for filesystem-backed SingleBinary
            schemaConfig:
              configs:
                - from: 2024-04-01
                  store: tsdb
                  object_store: filesystem
                  schema: v13
                  index:
                    prefix: index_
                    period: 24h
            # Enable volume metrics reporting in Loki limits (required by Grafana log volume UI)
            limits_config:
              volume_enabled: true
            commonConfig:
              replication_factor: "{{ loki_replication_factor }}"
          # defensive top-level object_store setting to avoid defaulting to s3
          object_store:
            type: filesystem
          # ensure scalable/simple-scalable targets are disabled (replicas=0)
          write:
            replicas: 0
          read:
            replicas: 0
          backend:
            replicas: 0
          # ensure minio subchart is explicitly disabled
          minio:
            enabled: false
          # Disable auxiliary Loki components when running in SingleBinary mode
          # on single-node clusters to avoid ring/ingester membership complexity.
          gateway:
            enabled: false
          chunksCache:
            enabled: false
          resultsCache:
            enabled: false
          canary:
            enabled: false
          compactor:
            enabled: false
          querier:
            enabled: false
          singleBinary:
            persistence:
              enabled: "{{ loki_persistence_enabled | default(true) | bool }}"
              size: "{{ loki_persistence_size }}"
              storageClass: "{{ loki_persistence_storage_class }}"
        wait: true
        wait_timeout: "{{ helm_install_timeout | default('300') }}"

- name: Build Fluent Bit namespace regex from whitelist or project list
  when: loki_enabled and fluentbit_enabled
  ansible.builtin.set_fact:
    fluentbit_namespace_regex: >-
      {{ (fluentbit_namespace_whitelist | join('|'))
         if (fluentbit_namespace_whitelist | length) > 0
         else (self_saas_projects | map(attribute='name') | list | join('|')) }}

- name: Render Fluent Bit outputs template
  when: loki_enabled and fluentbit_enabled
  ansible.builtin.set_fact:
    fluentbit_outputs: "{{ lookup('template', 'fluent-bit-outputs.conf.j2') }}"

- name: Render Fluent Bit filters template
  when: loki_enabled and fluentbit_enabled
  ansible.builtin.set_fact:
    fluentbit_filters: "{{ lookup('template', 'fluent-bit-filters.conf.j2') }}"

- name: Render Fluent Bit parsers template
  when: loki_enabled and fluentbit_enabled
  ansible.builtin.set_fact:
    fluentbit_parsers: "{{ lookup('template', 'fluent-bit-parsers.conf.j2') }}"

- name: Render Fluent Bit inputs template
  when: loki_enabled and fluentbit_enabled
  ansible.builtin.set_fact:
    fluentbit_inputs: "{{ lookup('template', 'fluent-bit-inputs.conf.j2') }}"

- name: Install Fluent Bit (DaemonSet) to forward logs to Loki
  when: loki_enabled and fluentbit_enabled
  kubernetes.core.helm:
    name: "{{ loki_release_name }}-fluentbit"
    chart_ref: "{{ fluentbit_chart_ref }}"
    chart_version: "{{ fluentbit_chart_version }}"
    release_namespace: "{{ monitoring_namespace }}"
    create_namespace: false
    values:
      daemonset:
        enabled: true
      rbac:
        create: true
      serviceAccount:
        create: true
      # We render output/filters from role templates to make the config
      # easier to maintain and less error-prone.
      config:
        outputs: "{{ fluentbit_outputs }}"
        filters: "{{ fluentbit_filters }}"
        inputs: "{{ fluentbit_inputs }}"
        customParsers: "{{ fluentbit_parsers }}"
    wait: true
    wait_timeout: "{{ helm_install_timeout | default('300') }}"
